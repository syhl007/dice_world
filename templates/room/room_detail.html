<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/room/room_style.css' %}"/>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="{% static 'js/jquery-3.3.1.js' %}" type="text/javascript"></script>
    <script src="{% static 'h-ui/js/H-ui.js' %}" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            if (window.s) {
                window.s.close()
            }
            /*创建socket连接*/
            var socket = new WebSocket("ws://" + window.location.host + "/ws/private_chat/");
            socket.onopen = function () {
                console.log('WebSocket open');  //成功连接上Websocket
            };
            socket.onmessage = function (e) {
                console.log('message: ' + e.data);//打印出服务端返回过来的数据
            };
            // Call onopen directly if socket is already open
            if (socket.readyState == WebSocket.OPEN) socket.onopen();
            window.s = socket;
        });
        var room_chat_form = $("form.room_post_msg");

        var room_chat_state = 'game';

        function room_change_state(state) {
            room_chat_state = state;
            if (state == 'game') {
                room_txt = room_game_txt;
                time_line = game_chat_time_line;
            } else {
                room_txt = room_other_txt;
                time_line = other_chat_time_line;
            }
            $("div.room_text_board").html(room_txt);
            $("div.room_text_board").scrollTop(99999);
            setTimeout("refresh_txt_board(room_chat_form.attr('action'))", 1);
        }

        var room_game_txt = new Array();
        var room_other_txt = new Array();
        var room_txt = room_game_txt;

        var game_chat_time_line = new Array(1);
        var other_chat_time_line = new Array(1);
        var time_line = game_chat_time_line;

        function refresh_txt_board(url) {
            $.ajax({
                url: url,
                type: 'get',
                data: {'state': room_chat_state, 'time_line': time_line[0]},
                success: function (data) {
                    var data = JSON.parse(data);
                    if (data.state == 0) {
                        var txt = JSON.parse(data.data);
                        time_line[0] = txt.time_line;
                        for (var i = 0; i < txt.list.length; i++) {
                            room_txt.push(txt.list[i] + "<br>");
                        }
                        $("div.room_text_board").html(room_txt);
                        $("div.room_text_board").scrollTop(99999);
                    }
                }
            });
        }

        var refresh_txt = setInterval("refresh_txt_board(room_chat_form.attr('action'))", 1500);

        function post_message() {
            $.ajax({
                url: room_chat_form.attr('action'),
                type: room_chat_form.attr('method'),
                data: room_chat_form.serialize(),
                complete: function () {
                    clearInterval(refresh_txt);
                    setTimeout("refresh_txt_board(room_chat_form.attr('action'))", 1);
                    refresh_txt = setInterval("refresh_txt_board(room_chat_form.attr('action'))", 1500);
                }
            });
        }

        function list_charater_from_room() {
            $('div#dialog').find('h3.modal-title').text('导入NPC（替换GM所扮演角色）');
            $('div#dialog').find('div.modal-body').load('{% url 'character:character_list_from_room' room.id %}', function () {
                $('div.before_main_page').css("display", "block");
                $('div.before_main_page h6.title').text('预选NPC');
                $('div.main_page h6.title').text('全部角色');
            });
            $('div#dialog').find('button.sure').css("display", "none");
            $("div#dialog").modal("show");
        }

        function list_task_from_room() {
            $('div#dialog').find('h3.modal-title').text('导入任务');
            $('div#dialog').find('div.modal-body').load('{% url 'room:list_task' room.id %}', function () {
                $('div.before_main_page').css("display", "block");
                $('div.before_main_page h6.title').text('预选任务');
                $('div.main_page h6.title').text('全部任务');
            });
            $('div#dialog').find('button.sure').css("display", "none");
            $("div#dialog").modal("show");
        }

        function list_item_from_room() {
            $('div#dialog').find('h3.modal-title').text('物品管理');
            $('div#dialog').find('div.modal-body').load('{% url 'room:list_item' room.id %}', function () {
                $('div.before_main_page').css("display", "block");
                $('div.after_main_page').css("display", "block");
                $('div.before_main_page h6.title').text('预选物品');
                $('div.main_page h6.title').text('队伍已有物品');
                $('div.after_main_page h6.title').text('全部物品');
            });
            $('div#dialog').find('button.sure').css("display", "none");
            $("div#dialog").modal("show");
        }
    </script>
</head>
<body>
<div id="dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content radius">
            <div class="modal-header">
                <h3 class="modal-title">标题</h3>
                <a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void(0);">×</a>
            </div>
            <div class="modal-body" style="width: 96%;height: 320px;OVERFLOW-Y: auto; OVERFLOW-X:hidden;">弹窗内容</div>
            <div class="modal-footer">
                <button class="btn btn-primary sure">确定</button>
                <button class="btn cancel" data-dismiss="modal" aria-hidden="true">关闭</button>
            </div>
        </div>
    </div>
</div>
{% if room %}
    <div class="room_info">
        {{ room.id }} ||【{{ room.num }}】{{ room.name }}
    </div>
    <div class="room_text_board">
    </div>
    <div class="room_funcation_list">
        ---------------------------------------
        {% if is_gm %}
            <div class="gm_box" style="float: right">
                <button>开始游戏</button>
                <button>保存记录</button>
                <button onclick="list_charater_from_room()">导入角色</button>
                <button onclick="list_task_from_room()">导入任务</button>
                <button onclick="list_item_from_room()">导入物品</button>
                <button onclick="list_area_from_room()">导入区域</button>
            </div>
        {% else %}
            <div class="player_box" style="float: right">
                <button onclick="list_personal_item_from_room()">查看物品</button>
            </div>
        {% endif %}
    </div>
    <div class="room_text_inport">
        <form method="post" action="" class="room_post_msg">
            <input type="radio" name="state" value="game" onclick="room_change_state('game')" checked>游戏发言
            <input type="radio" name="state" value="other" onclick="room_change_state('other')">闲聊发言<br>
            <input type="text" name="text" class="room_chat_content chat_box">
            {% csrf_token %}
            <input type="button" onclick="post_message()" value="发送">
        </form>
    </div>
{% else %}
    <p>No room are available.</p>
{% endif %}
</body>
</html>
